<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:exsl="http://exslt.org/common" xmlns:ng="http://docbook.org/docbook-ng" xmlns:fb="http://ogp.me/ns/fb#">
<head>
<link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet"/>
<link type="text/css" rel="stylesheet" href="styles/shCoreDefault.css"/>
<script type="text/javascript" src="scripts/shCore.js"><!----></script>
<script type="text/javascript">
               SyntaxHighlighter.config.space = ' ';
               SyntaxHighlighter.all();
</script>
<title>Havana преследуется Смертью - Руководство по эксплуатации OpenStack</title>
<meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/>
<meta name="mavenGroupId" content="org.openstack.docs"/>
<meta name="mavenArtifactId" content="openstack-ops-manual"/>
<meta name="mavenVersionId" content="1.0.0"/>
<link rel="home" href="index.html" title="Руководство по эксплуатации OpenStack"/>
<link rel="up" href="app_crypt.html" title="Дополнение B. Байки из зашиф^H^H^H^H облака"/>
<link rel="prev" href="rabbithole.html" title="Вниз по кроличьей норе"/>
<link rel="next" href="working-with-roadmaps.html" title="Дополнение C. Работа с дорожными картами"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="git-sha" content="13fb30b7c263d715eee84f0ca1a16df79697eb88"/>
<meta name="buildTime" content="2014-12-12T17:43:20+00:00"/>
<script type="text/javascript">
            //The id for tree cookie
            var treeCookieId = "treeview-openstack-operations-guide";
            var language = "en";
            var w = new Object();
            //Localization
            txt_filesfound = 'Results';
            txt_enter_at_least_1_char = "You must enter at least one character.";
            txt_browser_not_supported = "Please enable JavaScript.";
            txt_please_wait = "Please wait. Search in progress...";
            txt_results_for = "Results for: ";
</script>
<style type="text/css">
            input {
            margin-bottom: 5px;
            margin-top: 2px;
            }

            .folder {
            display: block;
            height: 22px;
            padding-left: 20px;
            background: transparent url(../common/jquery/treeview/images/folder.gif) 0 0px no-repeat;
            }
</style>
<link rel="shortcut icon" href="../favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="../common/css/positioning.css"/>
<link rel="stylesheet" type="text/css" href="../common/css/custom.css"/>
<link rel="canonical" href="http://docs.openstack.org/openstack-ops/content//haunted.html"/>
<!--[if IE]>
	<link rel="stylesheet" type="text/css" href="../common/css/ie.css"/>
<![endif]-->
<link rel="stylesheet" type="text/css" href="../common/jquery/theme-redmond/jquery-ui-1.8.2.custom.css"/>
<link rel="stylesheet" type="text/css" href="../common/jquery/treeview/jquery.treeview.css"/>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"><!----></script>
<script type="text/javascript" src="../common/jquery/jquery-ui-1.8.2.custom.min.js"><!----></script>
<script type="text/javascript" src="../common/jquery/jquery.cookie.js"><!----></script>
<script type="text/javascript" src="../common/jquery/treeview/jquery.treeview.min.js"><!----></script>
<link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/qtip2/2.2.0/jquery.qtip.min.css"/>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.js">
<!--jQuery plugin for glossary popups. --></script>
<script type="text/javascript" src="search/htmlFileList.js"><!----></script>
<script type="text/javascript" src="search/htmlFileInfoList.js"><!----></script>
<script type="text/javascript" src="search/nwSearchFnt.js"><!----></script>
<script type="text/javascript" src="search/stemmers/en_stemmer.js">
<!--//make this scalable to other languages as well.--></script>
<script type="text/javascript" src="search/index-1.js"><!----></script>
<script type="text/javascript" src="search/index-2.js"><!----></script>
<script type="text/javascript" src="search/index-3.js"><!----></script>
<script type="text/javascript">
	    var _gaq = _gaq || [];
	    _gaq.push(['_setAccount', 'UA-17511903-1']);
	    
	    _gaq.push(['_setDomainName', '.openstack.org']);	        
</script>
<script type="text/javascript" src="../common/ga.js"><!----></script>
<script language="javascript" src="/js/common.js"></script>
<script src="../common/highlight.pack.js"></script>
</head>
<body>
<!----><script type="text/javascript"><!--
hljs.initHighlightingOnLoad();
HeaderName = 'Havana преследуется Смертью';
PrevRef = 'rabbithole.html';
UpRef = 'app_crypt.html';
NextRef = 'working-with-roadmaps.html';//-->
</script>
<!----><script type="text/javascript" src="HeaderAndToolbar.js">
</script><script type="text/javascript"><!--
document.write(HeaderAndToolbar); //-->
</script>
<div id="content">
<div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both">
 <a id="haunted"> </a>Havana преследуется Смертью</h2>
</div></div></div>
<p>Данную историю внес Феликс Ли из Центра грид- вычислений Академии наук на Тайване.</p>
<p>Я только что обновил OpenStack с Grizzly на Havana 2013.2-2 
с использованием репозитория RDO и все работало довольно хорошо—
за исключением EC2 API.</p>
<p>Я заметил, что API страдал от тяжелой нагрузки и медленно отвечал 
на определенные запросы EC2,например, такие как <code class="literal">RunInstances</code>.</p>
<p>Вывод результатов из <code class="filename">/var/log/nova/nova-api.log</code> в Havana:</p>
<pre class="screen">2014-01-10 09:11:45.072 129745 INFO nova.ec2.wsgi.server
[req-84d16d16-3808-426b-b7af-3b90a11b83b0
0c6e7dba03c24c6a9bce299747499e8a 7052bd6714e7460caeb16242e68124f9]
117.103.103.29 "GET
/services/Cloud?AWSAccessKeyId=[something]&amp;Action=RunInstances&amp;ClientToken=[something]&amp;ImageId=ami-00000001&amp;InstanceInitiatedShutdownBehavior=terminate...
HTTP/1.1" status: 200 len: 1109 time: 138.5970151
</pre>
<p>Этот запрос потребовал две минуты на выполнение, однако 
быстро выполнялся в другой сосуществующей инсталляции Grizzly, 
использующей точно такое же оборудование и настройку системы.</p>
<p>Вывод результатов из <code class="filename">/var/log/nova/nova-api.log</code> в Grizzly:</p>
<pre class="screen">2014-01-08 11:15:15.704 INFO nova.ec2.wsgi.server
[req-ccac9790-3357-4aa8-84bd-cdaab1aa394e
ebbd729575cb404081a45c9ada0849b7 8175953c209044358ab5e0ec19d52c37]
117.103.103.29 "GET
/services/Cloud?AWSAccessKeyId=[something]&amp;Action=RunInstances&amp;ClientToken=[something]&amp;ImageId=ami-00000007&amp;InstanceInitiatedShutdownBehavior=terminate...
HTTP/1.1" status: 200 len: 931 time: 3.9426181
</pre>
<p>Выполнив мониторинг системных ресурсов, я заметил значительное увеличение 
потребления памяти при обработке данного запроса через EC2 API. 
Я предположил, что работа с памятью не идет должным образом—
возможно, она не освобождается. Если API получает несколько подобных 
запросов, потребление памяти быстро растет, пока в системе не заканчивается 
оперативная память и начинается использование свопинга. Каждый узел имеет 48 ГБ 
оперативной памяти и процесс &quot;nova-api&quot; может потребить ее все в течение 
нескольких минут. Как  только это происходит, вся система становится медленной и 
непригодной к использованию пока я не перезапущу службу 
<code class="systemitem">nova-api</code> service.</p>
<p>Следовательно, я задался вопросом: что же изменилось в редакции Havana
в EC2 API, что могло привести к тому что я наблюдаю. Является ли это ошибкой, или 
нормальным поведением, которое я должен теперь обойти?</p>
<p>После копания в коде Nova code, я отметил две области в 
<code class="filename">api/ec2/cloud.py</code>, потенциально влияющие на мою систему:</p>
<pre class="programlisting brush: python; ">
        instances = self.compute_api.get_all(context,
                                             search_opts=search_opts,
                                             sort_dir='asc')

        sys_metas = self.compute_api.get_all_system_metadata(
            context, search_filts=[{'key': ['EC2_client_token']},
                                   {'value': [client_token]}])
</pre>
<p>Поскольку моя база данных содержит много записей—
более одного миллиона записей метаданных и более 300`000 записей экземпляров в
сосотянии &quot;deleted&quot; или &quot;errored&quot;— каждая операция поиска 
занимает годы. Я решил почистить базу данных, предварительно создав архивную 
копию для резервного копирования и затем выполнив некоторые удаления при помощи 
клиента MySQL. Например, я выполнил следующие команды для удаления строк экземпляров, 
удаленных более года назад:</p>
<pre class="screen">mysql&gt; delete from nova.instances where deleted=1 and terminated_at &lt; (NOW() - INTERVAL 1 YEAR);</pre>
<p>Производительность значительно выросла после удаления старых записей и моя новая
инсталляция продолжает вести себя хорошо.</p>
</div>

<!----><script type="text/javascript" src="FooterAndSidebar.js">
</script><script type="text/javascript"><!--
document.write(FooterAndSidebar);//-->
</script>

</body></html>