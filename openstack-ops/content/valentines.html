<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:exsl="http://exslt.org/common" xmlns:ng="http://docbook.org/docbook-ng" xmlns:fb="http://ogp.me/ns/fb#">
<head>
<link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet"/>
<title>Массовое уничтожение вычислительных узлов в день всех влюбленных - Руководство по эксплуатации OpenStack</title>
<meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/>
<meta name="mavenGroupId" content="org.openstack.docs"/>
<meta name="mavenArtifactId" content="openstack-ops-manual"/>
<meta name="mavenVersionId" content="1.0.0"/>
<link rel="home" href="index.html" title="Руководство по эксплуатации OpenStack"/>
<link rel="up" href="app_crypt.html" title="Дополнение B. Байки из зашиф^H^H^H^H облака"/>
<link rel="prev" href="disappear_images.html" title="Пропадающие образы"/>
<link rel="next" href="rabbithole.html" title="Вниз по кроличьей норе"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="git-sha" content="13fb30b7c263d715eee84f0ca1a16df79697eb88"/>
<meta name="buildTime" content="2014-12-12T17:43:20+00:00"/>
<script type="text/javascript">
            //The id for tree cookie
            var treeCookieId = "treeview-openstack-operations-guide";
            var language = "en";
            var w = new Object();
            //Localization
            txt_filesfound = 'Results';
            txt_enter_at_least_1_char = "You must enter at least one character.";
            txt_browser_not_supported = "Please enable JavaScript.";
            txt_please_wait = "Please wait. Search in progress...";
            txt_results_for = "Results for: ";
</script>
<style type="text/css">
            input {
            margin-bottom: 5px;
            margin-top: 2px;
            }

            .folder {
            display: block;
            height: 22px;
            padding-left: 20px;
            background: transparent url(../common/jquery/treeview/images/folder.gif) 0 0px no-repeat;
            }
</style>
<link rel="shortcut icon" href="../favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="../common/css/positioning.css"/>
<link rel="stylesheet" type="text/css" href="../common/css/custom.css"/>
<link rel="canonical" href="http://docs.openstack.org/openstack-ops/content//valentines.html"/>
<!--[if IE]>
	<link rel="stylesheet" type="text/css" href="../common/css/ie.css"/>
<![endif]-->
<link rel="stylesheet" type="text/css" href="../common/jquery/theme-redmond/jquery-ui-1.8.2.custom.css"/>
<link rel="stylesheet" type="text/css" href="../common/jquery/treeview/jquery.treeview.css"/>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"><!----></script>
<script type="text/javascript" src="../common/jquery/jquery-ui-1.8.2.custom.min.js"><!----></script>
<script type="text/javascript" src="../common/jquery/jquery.cookie.js"><!----></script>
<script type="text/javascript" src="../common/jquery/treeview/jquery.treeview.min.js"><!----></script>
<link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/qtip2/2.2.0/jquery.qtip.min.css"/>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.js">
<!--jQuery plugin for glossary popups. --></script><script type="text/javascript" src="search/htmlFileList.js"><!----></script>
<script type="text/javascript" src="search/htmlFileInfoList.js"><!----></script>
<script type="text/javascript" src="search/nwSearchFnt.js"><!----></script>
<script type="text/javascript" src="search/stemmers/en_stemmer.js">
<!--//make this scalable to other languages as well.--></script>
<script type="text/javascript" src="search/index-1.js"><!----></script>
<script type="text/javascript" src="search/index-2.js"><!----></script>
<script type="text/javascript" src="search/index-3.js"><!----></script>
<script type="text/javascript">
	    var _gaq = _gaq || [];
	    _gaq.push(['_setAccount', 'UA-17511903-1']);
	    
	    _gaq.push(['_setDomainName', '.openstack.org']);	        
</script>
<script type="text/javascript" src="../common/ga.js"><!----></script>
<script language="javascript" src="/js/common.js"></script>
<script src="../common/highlight.pack.js"></script>
</head>
<body>
<!----><script type="text/javascript"><!--
hljs.initHighlightingOnLoad();
HeaderName = 'Массовое уничтожение вычислительных узлов в день всех влюбленных';
PrevRef = 'disappear_images.html';
UpRef = 'app_crypt.html';
NextRef = 'rabbithole.html';//-->
</script>
<!----><script type="text/javascript" src="HeaderAndToolbar.js">
</script><script type="text/javascript"><!--
document.write(HeaderAndToolbar); //-->
</script>
<div id="content">
<div class="section"><div xmlns="" class="titlepage"><div><div><h2 xmlns="http://www.w3.org/1999/xhtml" class="title" style="clear: both">
 <a id="valentines"> </a>Массовое уничтожение вычислительных узлов в день всех влюбленных</h2>
</div></div></div>
<p>Хотя название этой истории намного драматичнее действительных событий,
я не думаю, или, точнее, надеюсь больше не иметь возможности использовать
в заголовке вновь "Valentine's Day Massacre".</p>
<p>Это произошло в Валентинов день. Я получил сообщение, что один из 
вычислительных узлов больше не доступен в понимании этого в облаке,
        </p>
<pre class="screen">$nova-manage service list</pre>
<p>выдает для данного узла состояние <code class="code">XXX</code>.</p>
<p>Я вошел в контроллер облака и смог выполнить и <span class="command"><strong>ping</strong></span>, 
и SSH к проблемному вычислительному узлу, что показалось очень странным. 
Обычно, если я получаю такой тип уведомления, вычислительный узел 
полностью блокирован и не доступен.</p>
<p>После нескольких минут поиска неисправностей я обнаружил следующие подробности:</p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<p>В последнее время gользователь пытался запускать экземпляр CentOS на этом узле</p></li><li class="listitem">
<p>Этот пользователь был единственным пользователем на данном узле (новый узел)</p></li><li class="listitem">
<p>Нагрузка скакнула до 8 непосредственно перед получением мной данного предупреждения</p></li><li class="listitem">
<p>Связанное 10гб сетевое устройство (bond0) находилось в состоянии DOWN</p></li><li class="listitem">
<p>Сетевая плата 1гб все еще оставалась живой и активной</p></li></ul>
</div>
<p>Я изучил состояние обоих сетевых адаптеров, соединенных в пару, и увидел,
что ни один из них не был способен соединиться с портом коммутатора. 
Обнаружив, что каждый адаптер в связке подключен к отдельному коммутатору, 
я предположил, что вероятность отказа на каждом коммутаторе по порту в одно и то же время 
крайне маловероятна. Я решил, что двухпортовый 10гб сетевой адаптер скончался 
должен быть заменен. Я почувствовал, что мне повезло, что это был новый узел и никто 
еще не расположился на нем пока.</p>
<p>Через час я получил точно такое же сообщение, но теперь для другого узла. Хрень!
Ну ладно, теперь совершенно понятно что существует какая-то проблема. 
Как и на первом узле, я смог войти через SSH. 
NIC bond0 находился в состоянии DOWN, но 1гб NIC  был доступен.</p>
<p>И хорошая часть: тот же пользователь только что попытался создать экземпляр CentOS. 
Что-а?</p>
<p>В этом месте я оказался в полном замешательстве, так что написал 
нашим сетевому администратору просьбу, если это возможно, посмотреть 
чем он может мне помочь. Он подключился к обоим коммутаторам и 
сразу увидел проблему: коммутаторы обнаружили пакеты алгоритма связующего дерева 
(spanning tree), приходящие от двух вычислительных узлов и немедленно 
отключили эти порты чтобы предотвратить зацикливания алгоритма связующего дерева:</p>
<pre class="screen">Feb 15 01:40:18 SW-1 Stp: %SPANTREE-4-BLOCK_BPDUGUARD: Received BPDU packet on Port-Channel35 with BPDU guard enabled. Disabling interface. (source mac fa:16:3e:24:e7:22)
Feb 15 01:40:18 SW-1 Ebra: %ETH-4-ERRDISABLE: bpduguard error detected on Port-Channel35.
Feb 15 01:40:18 SW-1 Mlag: %MLAG-4-INTF_INACTIVE_LOCAL: Local interface Port-Channel35 is link down. MLAG 35 is inactive.
Feb 15 01:40:18 SW-1 Ebra: %LINEPROTO-5-UPDOWN: Line protocol on Interface Port-Channel35 (Server35), changed state to down
Feb 15 01:40:19 SW-1 Stp: %SPANTREE-6-INTERFACE_DEL: Interface Port-Channel35 has been removed from instance MST0
Feb 15 01:40:19 SW-1 Ebra: %LINEPROTO-5-UPDOWN: Line protocol on Interface Ethernet35 (Server35), changed state to down</pre>
<p> </p>
<p>Он включил эти порты коммутаторов и два вычислительных узла немедленно вернулись к жизни.</p>
<p>К сожалению эта история пока не имеет завершения... мы все еще 
ищем почему образ CentOS посылал пакеты связующего дерева. Кроме того, 
мы тщательно исследовали как смягчить то что произошло. Это гораздо 
бОльшая проблема, чем можно было бы подумать. Хотя для коммутаторов крайне важно 
предотвращать зацикливания связующих деревьев, очень проблематично быть 
вынужденным отрезать целый вычилительный узел из сети при возникновении подобной ситуации.
Если на вычислительном узле расположены 100 экземпляров и один из них посылает пакеты 
связующего дерева, получается, что этот экземпляр фактически DDOS-ит 
остальные 99 экземпляров.</p>
<p>Это продолжает оставаться горячей темой в сетевых кругах—
в особенности с увеличением виртуализации и виртуальных коммутаторов.</p>
</div>

<!----><script type="text/javascript" src="FooterAndSidebar.js">
</script><script type="text/javascript"><!--
document.write(FooterAndSidebar);//-->
</script>

</body></html>